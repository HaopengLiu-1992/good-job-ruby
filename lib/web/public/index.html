<html ng-app>

<head>
  <title>Indexer Status</title>
  <script src="vendor/angular.min.js"></script>
  <script src="vendor/jquery.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="host.js"></script>
  <script src="batch_indexers.js"></script>
  <script src="status.js"></script>
  <script src="backfill.js"></script>
  <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
  <link href="index.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
</head>
<body>
  <div id="main">
    <h2>Indexer Status</h2>
    <div id="info" ng-controller='StatusCtrl'>
      <h3>Hosts</h3>
      <table class="table">
        <tr ng-repeat="host in hosts">
          <td>{{host.host}}:{{host.port}}</td>
          <td>{{host.formattedBackend()}}</td>
          <td>{{host.formattedShards()}}</td>
        </tr>
      </table>
      <h4>
        <a data-toggle="collapse" data-target="#incremental-container" href="javascript:void(0)">&#x25b6; {{incrementals.length}} incremental indexers running.</a>
      </h4>
      <div class="incremental-overview">
        <div class="collapse" id="incremental-container">
          <table class="incremental-detail table collapse" id="incremental-detail">
            <tr>
              <th>host</th>
              <th>shard</th>
              <th>type</th>
              <th>last-indexed</th>
            </tr>
            <tr class="incremental-detail-row" ng-repeat="incremental in incrementals">
              <td>{{incremental.host}}:{{incremental.port}}</td>
              <td>{{incremental.shard}}</td>
              <td>{{incremental.type}}</td>
              <td>{{incremental.max_timestamp}}</td>
            </tr>
          </table>
        </div>
      </div>
      <h4>
        <a data-toggle="collapse" data-target="#backfill-container" href="javascript:void(0)">&#x25b6; {{backfills.length}} backfills with status.</a>
      </h4>
      <div class="collapse" id="backfill-container">
        <table class="backfill-detail table">
          <tr>
            <th>host</th>
            <th>information</th>
            <th>progress</th>
            <th>% complete</th>
          </tr>
          <tr class="incremental-detail-row" ng-repeat="backfill in backfills">
            <td>{{backfill.host}}:{{backfill.port}}</td>
            <td class="text-line-box">{{backfill.information()}}</td>
            <td>{{backfill.progress()}}</td>
            <td>
             <div class="progress">
               <div class="bar" style="width: {{backfill.percentComplete()}}%;"></div>
                  <div class="progress-text">
                    {{backfill.percentComplete()}}% complete
                  </div>
             </div>
            </td>
          </tr>
        </table>
      </div>
      <h4 ng-show="activeReindexes.length > 0">Reindexes in Progress</h4>
      <div class="reindex-container" ng-repeat="reindex in activeReindexes">
          <a data-toggle="collapse" data-target="#reindex-container-{{reindex.key}}-progress" ng-click="collapseReindex(reindex.key)" href="javascript:void(0)">
            <div>
              <h4 class="dropdownInactive" ng-class="{'dropdownActive': reindexCollapses[reindex.key]}">Reindexing {{reindex.collection}} {{reindex.indexStatus()}}: {{reindex.totalProgress()}}</h4>
              <div class="reindex-host">{{reindex.host}}:{{reindex.port}}</div>
            </div>
          </a>
          <div class="collapse{{reindex.collapseClass}}" id="reindex-container-{{reindex.key}}-progress">
          key: {{reindex.key}}
          <div class="reindex-collection-row" ng-repeat="col in reindex.children">
            <table class='reindex-collection-detail table'>
              <tr class="info">
                <td>{{reindex.collection}} {{col.information()}}</td>
                <td>{{col.progress()}}</td>
                <td class="progress-cell">
                  <div class="progress">
                    <div class="bar" style="width: {{col.percentComplete()}}%;">
                      <div class="progress-text">
                        {{col.percentComplete()}}% complete
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              <tr ng-repeat="shard in col.children">
                <td>{{shard.information()}}</td>
                <td>{{shard.progress()}}</td>
                <td class="progress-cell">
                  <div class="progress">
                    <div class="bar" style="width: {{shard.percentComplete()}}%;">
                      <div class="progress-text">
                        {{shard.percentComplete()}}% complete
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <h4 ng-show="completedReindexes.length > 0">Completed Reindexes</h4>
      <div class="reindex-container" ng-repeat="reindex in completedReindexes">
          <a data-toggle="collapse" data-target="#reindex-container-{{reindex.key}}-complete" ng-click="collapseReindex(reindex.key)" href="javascript:void(0)"><h4>&#x25b6;
            Reindexing {{reindex.collection}}: {{reindex.host}}:{{reindex.port}} {{reindex.progress()}}</h4>
          </a>
          <div class="collapse{{reindex.collapseClass}}" id="reindex-container-{{reindex.key}}-complete">
          key: {{reindex.key}}
          <div class="reindex-collection-row" ng-repeat="col in reindex.children">
            <table class='reindex-collection-detail table'>
              <tr class="info">
                <td>{{reindex.collection}} {{col.information()}}</td>
                <td>{{col.progress()}}</td>
                <td class="progress-cell">
                  <div class="progress">
                    <div class="bar" style="width: {{col.percentComplete()}}%;">
                      <div class="progress-text">
                        {{col.percentComplete()}}% complete
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              <tr ng-repeat="shard in col.children">
                <td>{{shard.information()}}</td>
                <td>{{shard.progress()}}</td>
                <td class="progress-cell">
                  <div class="progress">
                    <div class="bar" style="width: {{shard.percentComplete()}}%;">
                      <div class="progress-text">
                        {{shard.percentComplete()}}% complete
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <h4>
      <a data-toggle="collapse" data-target="#backfill-submit-container" href="javascript:void(0)">&#x25b6; Kickoff a backfill</a>
    </h4>
    <div class="collapse" id="backfill-submit-container">
      <form ng-submit="triggerBackfill()" ng-controller='BackfillCtr'>
        <div ng-show="statusReport" style: 'margin: 20px; min-height: 50px;'>
          <div ng-show="success" class="label label-success">
            <div>
              <div>
                Success!
              </div>
              <div>
                You can track progress at url: <a href="{{backfillUrl}}" target="new" style="color: white">{{backfillUrl}}</a>
              </div>
            </div>
          </div>

          <div ng-show="failed" class="label label-warning">
            <div>
              Something went wrong!
            </div>
            <div>
              Error: {{error}}  {{errorMessage}}
            </div>
          </div>

        </div>
        <div>
          To Shard (Required):
        </div>
        <div>
          <input type="text" ng-model="toShard" name="to-shard"  class="input-small" required/>
        </div>

        <div>
          From Shard (Optional: same as "To Shard" if not given):
        </div>
        <div>
          <input type="text" ng-model="fromShard" name="from-shard" class="input-small" />
        </div>

        <div>
          Collection Name:
        </div>
        <div>
          <input type="text" ng-model="name" name="name" />
        </div>

        <div>
          Types (Optional: comma separated types. All types will be backfilled for a given collection if this is empty or has value 'all'):
        </div>
        <div>
          <input type="text" ng-model="types" name="types" />
        </div>

        <div>
          Accounts (Required: comma separated account ids):
        </div>
        <div>
          <input type="text" ng-model="accounts" name="accounts" required/>
        </div>

        <div>
          <input type="submit" id="submit" value="Submit" class="btn" />
        </div>
      </form>
    </div>
  </div>
</body>
</html>


